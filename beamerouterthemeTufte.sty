% Beamer Outer Theme: Tufte
% Defines headline, footline, and navigation elements
% Minimalist design with progress bar

\mode<presentation>

% Process theme options
\DeclareOptionBeamer{nosectionheader}{\def\tufte@nosectionheader{true}}
\DeclareOptionBeamer{navontop}{\def\tufte@navontop{true}}
\ProcessOptionsBeamer

% Remove default navigation symbols
\setbeamertemplate{navigation symbols}{}

% Helper commands to ignore arguments
\newcommand{\@gobblefive}[5]{}
\newcommand{\@gobblesix}[6]{}

% Counter for tracking slides in current section
\newcount\tufte@slidecount

% Helper to parse page range in format "first/last"
\def\tufte@parserange#1/#2\relax{%
  \def\tufte@rangefirst{#1}%
  \def\tufte@rangelast{#2}%
}

% Custom section navigation - sections on left
\newcommand{\tufte@sectionentry}[5]{%
  \ifnum#1>1\hspace{1em}\fi% Add space between sections
  \ifnum\c@section=#1%
    % Reset counter when entering current section
    \global\tufte@slidecount=0\relax%
    {\usebeamercolor[fg]{tufteaccent}\textbf{#2}}%
  \else%
    {\usebeamercolor[fg]{section in head/foot shaded}#2}%
  \fi%
}

% Mini frames (circles) only for current section - shown on right
% #1=section, #2=subsection, #3=slide in subsection, #4=first/last page, #5=subsection name, #6=part
\def\tufte@slideentry#1#2#3#4#5#6{%
  % Only show circles for current section
  \ifnum#1=\c@section\relax%
    \ifnum#3>0\relax% Skip if slide number is 0 (backup slides)
      % Increment slide count for current section
      \global\advance\tufte@slidecount by 1\relax%
      % Parse the page range "first/last"
      \tufte@parserange#4\relax%
      % Determine if this is the current slide
      \def\tufte@circlestyle{0}% Default: outlined circle
      \ifnum\tufte@rangefirst>0\relax%
        % Check if current page is within this slide's page range
        \ifnum\c@page<\tufte@rangefirst\relax%
          % Before this slide - outlined
        \else%
          \ifnum\c@page>\tufte@rangelast\relax%
            % After this slide - outlined
          \else%
            % Current slide - filled circle
            \def\tufte@circlestyle{1}%
          \fi%
        \fi%
      \fi%
      % Draw circle
      \raisebox{0.1ex}{\begin{pgfpicture}{0pt}{0pt}{0.12cm}{0.12cm}%
        \ifnum\tufte@circlestyle=1\relax%
          \color{tufteaccent}%
          \pgfpathcircle{\pgfpoint{0.06cm}{0.06cm}}{0.06cm}%
          \pgfusepath{fill}%
        \else%
          \color{tuftegray}%
          \pgfpathcircle{\pgfpoint{0.06cm}{0.06cm}}{0.06cm}%
          \pgfusepath{stroke}%
        \fi%
      \end{pgfpicture}}%
    \fi%
  \fi%
}

% Disable sidebar
\setbeamersize{sidebar width left=0cm, sidebar width right=0cm}

%--------------------------------------------------
% HEADLINE: Section name + Navigation squares + Frame title
%--------------------------------------------------

% Store the frame title in a custom command
\newcommand{\tufteframetitle}{}

% Patch \frametitle to store the title
\let\oldframetitle\frametitle
\renewcommand{\frametitle}[1]{%
  \gdef\tufteframetitle{#1}%
  \oldframetitle{#1}%
}

\defbeamertemplate*{headline}{Tufte theme}{%
  \ifnum\c@framenumber=1
    % No headline on title page
  \else
    % Navigation sections on top (if navontop option is set)
    \ifx\tufte@navontop\undefined
      % Default: no navigation on top
    \else
      % Show section names on left | circles on right (same line)
      \vskip0.3ex%
      \begin{beamercolorbox}[wd=\paperwidth,ht=2.5ex,dp=0.5ex,leftskip=1cm,rightskip=1cm]{navigation}
        {\tiny%
          % Section names
          \let\sectionentry\tufte@sectionentry\let\slideentry\@gobblesix\def\lastpartialnumber{0}\dohead%
          % Vertical separator
          \hspace{1em}{\color{tuftegray}\rule{0.4pt}{1.2ex}}\hspace{1em}%
          % Circles for current section
          \beamer@slideinframe=0\relax%
          \let\sectionentry\@gobblefive\let\slideentry\tufte@slideentry\def\lastpartialnumber{0}\dohead%
        }%
      \end{beamercolorbox}
      % Thin separator line below navigation
      \vskip0.3ex%
      \hspace*{1cm}{\color{tuftegray}\rule{\dimexpr\paperwidth-2cm\relax}{0.3pt}}%
      \vskip0.5ex%
    \fi
    % Main headline: section name + frame title
    \begin{beamercolorbox}[wd=\paperwidth,ht=3ex,dp=1.5ex,leftskip=1cm,rightskip=.5em]{headline}
      \usebeamerfont{headline}%
      % Conditionally show section name and separator
      \ifx\tufte@nosectionheader\undefined
        % Section name (small and less prominent, aligned with separator line)
        {\tiny\color{tuftegray}\insertsectionhead}%
        \hspace{0.7em}%
        % Vertical bar separator
        {\color{tuftegray}\rule{0.4pt}{1.2ex}}%
        \hspace{0.7em}%
      \fi
      % Frame title (always shown)
      {\usebeamerfont{frametitle}\tufteframetitle}%
    \end{beamercolorbox}
    % Separator line below headline (matching content width)
    \vskip0.5ex%
    \hspace*{1cm}{\color{tuftegray}\rule{\dimexpr\paperwidth-2cm\relax}{0.4pt}}%
    \vskip1ex%
  \fi
}

% Remove ALL spacing between navigation elements
\setbeamertemplate{mini frame}{}%
\setbeamertemplate{mini frame in current subsection}{}%
\setbeamertemplate{mini frame in other subsection}{}%

% CRITICAL: Remove separator spacing between section navigation items
\defbeamertemplate{section in head/foot separator}{none}{}
\setbeamertemplate{section in head/foot separator}[none]

% Custom section navigation - render as squares with ABSOLUTELY NO SPACING
\setbeamertemplate{section in head/foot}{%
  \raisebox{0.1ex}{%
    \begin{pgfpicture}{0pt}{0pt}{0.12cm}{0.12cm}%
      % Current section - filled square
      \color{tuftetext}%
      \pgfpathrectangle{\pgfpointorigin}{\pgfpoint{0.12cm}{0.12cm}}%
      \pgfusepath{fill}%
    \end{pgfpicture}%
  }%
}

\setbeamertemplate{section in head/foot shaded}{%
  \raisebox{0.1ex}{%
    \begin{pgfpicture}{0pt}{0pt}{0.12cm}{0.12cm}%
      % Other sections - outlined square
      \color{tuftegray}%
      \pgfpathrectangle{\pgfpointorigin}{\pgfpoint{0.12cm}{0.12cm}}%
      \pgfusepath{stroke}%
    \end{pgfpicture}%
  }%
}

%--------------------------------------------------
% FOOTLINE: Progress bar + page numbers (flush bottom)
%--------------------------------------------------

\defbeamertemplate*{footline}{Tufte theme}{%
  \ifnum\c@framenumber=1
    % No footline on title page
  \else
    % Calculate progress (handle case when there's only 1 frame)
    % Progress bar width matches headline line width (paperwidth - 2cm for margins)
    \pgfmathsetlength{\@tempdima}{\paperwidth-2cm}
    \ifnum\inserttotalframenumber>1
      \pgfmathsetmacro{\progress}{(\insertframenumber-1)/(\inserttotalframenumber-1)}
      \pgfmathsetmacro{\progresswidth}{\progress*\@tempdima}
    \else
      \pgfmathsetmacro{\progress}{1}
      \pgfmathsetmacro{\progresswidth}{\@tempdima}
    \fi

    % Single colorbox containing footer text, progress bar, and page numbers
    \begin{beamercolorbox}[wd=\paperwidth,ht=5ex,dp=1.5ex,leftskip=0em,rightskip=0.5em]{footline}
      % Footer text (if set) - shown above progress bar in very small font
      \ifx\tuftefootertext\@empty
        % No footer text, maintain spacing
        \vskip3ex
      \else
        \vskip1.5ex
        \hspace*{1cm}{\tiny\color{tuftedarkgray}\tuftefootertext}%
        \vskip0.5ex
      \fi
      % Draw progress bar raised from bottom
      \hspace*{1cm}% Left margin offset
      \begin{tikzpicture}
        % Background (light gray line)
        \fill[tuftegray] (0,0) rectangle (\@tempdima,0.08cm);
        % Progress (accent color line)
        \fill[tufteaccent] (0,0) rectangle (\progresswidth pt,0.08cm);
        % Page numbers overlaid on the right
        \node[anchor=south east,inner sep=0pt,text=tuftedarkgray] at (\@tempdima,0.15cm)
          {\usebeamerfont{page number in head/foot}\insertframenumber\,/\,\inserttotalframenumber};
      \end{tikzpicture}
    \end{beamercolorbox}
  \fi
}

%--------------------------------------------------
% FRAME TITLE (now in headline, not displayed in content area)
%--------------------------------------------------

\defbeamertemplate*{frametitle}{Tufte theme}{%
  % Frame title appears in headline for regular frames
  % Only show in content area for plain frames (no headline/footline)
  \ifbeamer@plainframe
    \vskip0.5em
    \begin{beamercolorbox}[wd=\textwidth,leftskip=0em,rightskip=0em]{frametitle}
      \usebeamerfont{frametitle}\insertframetitle
      \ifx\insertframesubtitle\@empty
      \else
        \par\vskip-0.3em
        {\usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}\insertframesubtitle}
      \fi
    \end{beamercolorbox}
    \vskip0.5em
  \fi
  % For regular frames, title is shown in headline only
}

% Section page template (centered, minimal)
\defbeamertemplate*{section page}{Tufte theme}{
  \centering
  \vfill
  \begin{beamercolorbox}[sep=12pt,center]{section title}
    \usebeamerfont{section title}\insertsection\par
  \end{beamercolorbox}
  \vfill
}

% Add section page command
\newcommand{\sectionframe}{%
  {%
    \setbeamertemplate{headline}{}%
    \setbeamertemplate{footline}{}%
    \begin{frame}[c,plain]
      \sectionpage
    \end{frame}
  }%
}

\mode<all>
